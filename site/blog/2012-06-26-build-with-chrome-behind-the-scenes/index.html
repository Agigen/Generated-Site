<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"
  ng-app="agigenApp"
  ng-controller="menuCtrl"
  ng-class="{'menu-open': menuVisible2}"
  scroll-spy
  ng-keyup="menuKeyup($event)"
>
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    Build with Chrome behind the scenes
    
    &middot; Agigen
    
  </title>

  <script>
    if ("ActiveXObject" in window) {
      document.getElementsByTagName('html')[0].className += ' browser--ie';
    }

    if (/ip(ad|hone|od)/gi.test(navigator.userAgent)) {
      document.getElementsByTagName('html')[0].className += ' device--ios';
    }

    if (/firefox/gi.test(navigator.userAgent)) {
      document.getElementsByTagName('html')[0].className += ' browser--firefox';
    }
  </script>

  
  
  <link rel="stylesheet" href="/css/agigen.css?v=1">

  

  <link rel="shortcut icon" href="/img/utils/favicon.ico">

  <link rel="apple-touch-icon" sizes="152x152" href="/img/utils/apple-touch-icon.png">

  <link rel="icon" type="image/png" href="/img/utils/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/img/utils/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/img/utils/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/img/utils/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/img/utils/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#b91d47">
  <meta name="msapplication-TileImage" content="/img/utils/mstile-144x144.png">

  <meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta property="fb:admins" content="562883652,1205209891">
<meta property="og:site_name" content="Agigen.se">
<meta name="twitter:site" content="@agigen">
<meta name="twitter:creator" content="@lendai">
<meta property="og:url" content="http://agigen.se/blog/2012-06-26-build-with-chrome-behind-the-scenes/">





    
    <meta itemprop="name" content="Agigen - We make the web a better place">
    <meta property="og:title" content="Agigen - We make the web a better place">
    <meta name="twitter:title" content="Agigen - We make the web a better place">



    
        
        <meta itemprop="description" content="Creative web agency based in Stockholm, Sweden. We create beautiful design, powerful code and cool ideas.">
        <meta name="description" content="Creative web agency based in Stockholm, Sweden. We create beautiful design, powerful code and cool ideas.">
        <meta property="og:description" content="Creative web agency based in Stockholm, Sweden. We create beautiful design, powerful code and cool ideas.">
        <meta name="twitter:description" content="Creative web agency based in Stockholm, Sweden. We create beautiful design, powerful code and cool ideas.">
    



    
    <meta itemprop="image" content="http://agigen.se/img/utils/opengraph.jpg ">
    <meta property="og:image" content="http://agigen.se/img/utils/opengraph.jpg ">
    <meta name="twitter:image" content="http://agigen.se/img/utils/summary_card_twitter.jpg">









  <link rel="dns-prefetch" href="//ajax.googleapis.com">
  <link rel="dns-prefetch" href="//agigen-slack-chat.appspot.com">

  <script type="text/javascript" charset="utf-8">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7546376-1']);
      _gaq.push(['_trackPageview']);
  </script>

  <script type="text/javascript" src="//use.typekit.net/orr5jqv.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body
class="
page--build-with-chrome-behind-the-scenes

  page--page
  page--blog
  page--blog--build-with-chrome-behind-the-scenes

">
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<!-- 

                      `://.
                    `+AAAAAo.
                  `+AAAAAAAAAo.
                `+AAAAAAAAAAAAAo.
              `+AAAAAAAAAAAAAAAAAo.
            `+AAAAAAAAAAAAAAAAAAAAAo.
          `+AAAAAAAAAs/sAAAAAAAAAAAAAo.
        `+AAAAAAAAAA+`  -oAAAAAAAAAAAAAo.
      `+AAAAAAAAAAA+      .+AAAAAAAAAAAAAo.
    `+AAAAAAAAAAAA/         .+AAAAAAAAAAAAAo.
  `+AAAAAAAAAAAAA/            .+AAAAAAAAAAAAAo.
 +AAAAAAAAAAAAAA/               -sAAAAAAAAAAAAAo`
.AAAAAAAAAAAAAA+                 `+AAAAAAAAAAAAA/
 /AAAAAAAAAAAAs`       `-/+agigen:`:AAAAAAAAAAAo`
  `/AAAAAAAAAA.    .:+AAAAAAAAAAAAA+/AAAAAAAAo.
    `/AAAAAAAo.-/oAAAAAAAAAAAAAAAAAAAAAAAAAo.
      `/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAo.
        `/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAo.
          `/AAAAAAAAAAAAAAAAAAAAAAAAAo.
            `+AAAAAAAAAAAAAAAAAAAAAo.
              `+AAAAAAAAAAAAAAAAAo.
                `+AAAAAAAAAAAAAo.
                  `+AAAAAAAAAo.
                    `+AAAAAo.
                      `-::`
-->



<nav class="main-menu" ng-class="{'main-menu--expanded': menuVisible, 'main-menu--visible-content': menuVisible2}" ng-click="hideMenu($event)">
    <section class="main-menu__grid">
        <ul class="nav nav--stacked">
            
            
                
                <li>
                    <a class="main-menu__link main-menu__link--main" href="/">Home</a>
                
                </li>
            
                
                <li class="sub-menu">
                    <span class="main-menu__section-name">Services</span>
                    <ul class="sub">
                    
                        <li>
                        <a href="/services/web-production" class="main-menu__link main-menu__link--sublink main-menu__link--webprod"> Web Production </a>
                        </li>
                    
                        <li>
                        <a href="/services/product-development" class="main-menu__link main-menu__link--sublink main-menu__link--proddev"> Product development </a>
                        </li>
                    
                        <li>
                        <a href="/services/labs" class="main-menu__link main-menu__link--sublink main-menu__link--labs"> Agigen Labs </a>
                        </li>
                    
                    </ul>
                
                </li>
            
                
                <li class="sub-menu">
                    <span class="main-menu__section-name">Learn more</span>
                    <ul class="sub">
                    
                        <li>
                        <a href="/work/" class="main-menu__link main-menu__link--sublink main-menu__link--cases"> Case studies </a>
                        </li>
                    
                        <li>
                        <a href="/about/" class="main-menu__link main-menu__link--sublink main-menu__link--aboutus"> About us </a>
                        </li>
                    
                        <li>
                        <a href="/blog/" class="main-menu__link main-menu__link--sublink main-menu__link--blog"> Our diary </a>
                        </li>
                    
                    </ul>
                
                </li>
            
                
                <li class="sub-menu">
                    <span class="main-menu__section-name">Get in touch</span>
                    <ul class="sub">
                    
                        <li>
                        <a href="/contact/" class="main-menu__link main-menu__link--sublink main-menu__link--contactus"> Contact us </a>
                        </li>
                    
                    </ul>
                
                </li>
            
        </ul>
    </section>
</nav>

<div class="topbar-wrapper">
    <div class="topbar" ng-class="{'menu-expanded': menuVisible}" ng-style="{ 'padding-right': topbarCompensation }">
        <div class="container cf">
            <h1 class="topbar__title"><a href="/" title="Agigen.se">

                <svg class="color-animation" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 244.8 190.6" enable-background="new 0 0 244.8 190.6" xml:space="preserve">
                    <path  fill-rule="evenodd" clip-rule="evenodd" d="M92.1,3.8C105.7,15.2,219.5,105.1,240,185.9c-69.6-117.8-200.3,13.7-233.3,0
                        C-9.8,181.3,80.7-1.3,92.1,3.8z"></path>
                </svg>

            </a></h1>
    


            <button class="topbar__menu-button" ng-click="toggleMenu()" ng-class="{'topbar__menu-button--active': menuVisible}">

                <div class="topbar__menu-button__inner"></div>
                <span class="accessibility">Menu</span>

            </button>


        </div>
    </div>
</div>


<header class="main-header blog-post__header

    blog-post__header--category--backstage
">
    <div class="main-header__content">
        <div class="container text--light">
            <h1 class="main-header__title--blog text-wrapper">Build with Chrome behind the scenes</h1>
            <p>
                Posted Tue, Jun 26, 2012 in  Backstage 
            </p>
        </div>
    </div>
</header>
<div class="main-content">




<div class="content container">
    

    <article class="blog-post">
        

<p>We helped build this cool WebGL LEGO®/Google Maps thing, so I thought I&#8217;d talk for a bit about it.</p>

<p><img src="/img/blog/posts/2012/06/build.png" ></p>

<p><img title="agigen-blog-header" alt="" src="/img/blog/posts/2012/06/agigen-blog-header1.png" /></p>

<p>What some other sites had to say about our project: <a title="Engadget" href="http://www.engadget.com/2012/06/26/lego-and-google-chrome-build-australia/" target="_blank">Engadget</a>, <a title="The Verge" href="http://www.theverge.com/2012/6/26/3117910/google-lego-simulator-build-with-chrome" target="_blank">The Verge</a>, <a title="Gizmodo" href="http://gizmodo.com/5921316/you-can-now-build-virtual-lego-in-chrome" target="_blank">Gizmodo</a>, <a title="Wired.co.uk" href="http://www.wired.co.uk/news/archive/2012-06/26/build-with-chrome-lego" target="_blank">Wired.co.uk</a>, <a title="Mashable" href="http://mashable.com/2012/06/26/google-lego-build/" target="_blank">Mashable</a>, <a title="DailyTech" href="http://www.dailytech.com/Google+Adds+8+Trillion+Virtual+Lego+Bricks+to+Chrome/article25029.htm" target="_blank">DailyTech</a>, <a title="The Next Web" href="http://thenextweb.com/shareables/2012/06/26/kiss-goodbye-to-your-productivity-google-just-brought-8-trillion-lego-blocks-to-chrome/" target="_blank">The Next Web</a>.</p>

<h1 id="toc_0">Background</h1>

<p><a href="http://buildwithchrome.com/">Build with Chrome</a> is basically a Google Chrome and WebGL tech demo. The basic premise is to let users build whatever LEGO structures they want in a full 3D environment, using a baseplate that occupies a Google Maps tile. If you haven&#8217;t tried playing with it yet, go do so right now; at least for me, it turns out that playing with LEGO bricks is just as fun now as when I was 10 years old.</p>

<p>We got involved in the project as a subcontractor to <a href="http://www.northkingdom.com/">North Kingdom</a>. We&#8217;ve done some pretty cool stuff with them in the past; check out our cases.</p>

<p><img class="size-full wp-image-54" title="Build with Chrome prototype" alt="" src="/img/blog/posts/2012/06/agigen-blog-prototype.png" />
Early prototype of the builder mode</p>

<h1 id="toc_1">The application</h1>

<p>We were responsible for the backend system, implementing North Kingdom&#8217;s front end designs, and hooking up various components to each other, while North Kingdom and freelancer <a href="https://github.com/empaempa">Mikael Emtinger</a> handled design work and WebGL programming (mostly done via <a href="https://github.com/empaempa/GLOW">GLOW.js</a>).</p>

<p>The application structure is pretty simple: it consists of a handful of static HTML pages, a small RESTful API written in Python, and a humongous amount of JavaScript. There is no meaningful server-side generation of HTML templates going on; the entire thing is basically a JS application that uses AJAX requests to store and retrieve persistent data from the server. It&#8217;s hosted on Google App Engine for two reasons; scalability and simplicity. It&#8217;s really easy to build extremely scalable applications on the App Engine infrastructure, and it takes basically no effort at all to get going with a new project (which is very important when deadlines are looming). Pretty much the entire application was built in slightly over a month by about six full-time developers (three at Agigen, two at North Kingdom and one freelance).</p>

<h1 id="toc_2">Lessons learned</h1>

<p>Since one of the requirements was to use Google Maps tiles as baseplates, one of the first problems we had to solve was how to LEGO-ify a Google Maps image. In an early stage of the project, the plan was to LEGO-ify the entire map, and much time was spent discussing and testing how to make a LEGO-ified map look good and load quickly enough to make the experience decent for the user. The plan was eventually mostly scrapped, and it was decided to only make the 3D exploration mode (which you get if you zoom in far enough) LEGO-ified. We ended up with a very simple implementation that scales down each 256&#215;256 pixel Google Maps tile to 32&#215;32 (using nearest-neighbor sampling) and then reduces the color depth to a fixed 13-color palette. Fortunately for us, you can use the <a href="http://www.pythonware.com/products/pil/">Python Imaging Library (PIL)</a> on App Engine now, so this was pretty painless to do.</p>

<p>We also tossed around the idea of using topographical height data from the Google Maps API&#8217;s in order to make the baseplates &#8220;hilly&#8221;, but that plan was also scrapped; mostly for timing reasons, but also because the height data wasn&#8217;t really in a high enough resolution to make it interesting.</p>

<p><img class="size-full wp-image-55" title="Builder with Chrome" alt="" src="/img/blog/posts/2012/06/agigen-blog-builder.png" />
Builder mode as it looks today</p>

<p>The next problem was to find a decent way to automatically give users free plots to build on in some semi-predictable manner. Sounds easy enough, but it gets more complicated when you have many users who want to build in the same area. Checking if a plot is free or not in a race-condition-safe manner is a somewhat expensive operation (requiring a database read), so you can&#8217;t do too many checks in a single request, or the user experience will be terrible. After some experimentation and poking around we found an old simple trick that suited us: each baseplate (map tile) is assigned an integer X/Y coordinate pair (counted from the northwestern corner of the map). The coordinate pair is bitwise interleaved to form a single number (called a Morton code), which is stored in memcache (with database backup), so it&#8217;s easy to increment or decrement atomically, forming a <a href="http://en.wikipedia.org/wiki/Z-order_curve">Z-order curve</a>. Using a single number as a coordinate made it much easier and faster to look for free plots while keeping the assignment transaction safe.</p>

<p>We have also learned more about Google Maps (and more importantly what you cannot do with Google Maps) than we ever wanted to know. Among other things, it turns out that Google Maps ground overlays are really interesting creatures when they get so big that the curvature of the earth starts to matter; most of us have worked as web developers for our entire careers, which meant our math knowledge was severely rusty and not really up to the task of projecting flat images from onto the surface of an ellipsoid or deprojecting spheroid surface segments to flat images. We ended up scrapping that code path for other reasons, though.</p>

<h1 id="toc_3">&#8220;Interesting&#8221; numbers</h1>

<p>• Number of different coordinate systems used internally: 5 (latitude/longitude in WGS84 datum, Google Maps tile coordinates, Google Maps tile coordinates with the Y axis inverted, Morton code coordinates, &#8220;Spherical Mercator&#8221; metric coordinates (EPSG:3857))
• JS to Python code lines ratio: ~4.8:1 (~16550 lines of JS, 3400 lines of Python; both excluding third-party libraries other than GLOW)
• Number of real LEGO kits built during the development process: 4 (including the Death Star, see photo below)
• Number of dragons in the codebase: 3</p>

<p>Google&#8217;s official post about the project:<br>
<a title="http://google-au.blogspot.se/2012/06/build-bringing-lego-bricks-to-chrome.html" href="http://google-au.blogspot.se/2012/06/build-bringing-lego-bricks-to-chrome.html" target="_blank"><a href="http://google-au.blogspot.se/2012/06/build-bringing-lego-bricks-to-chrome.html">http://google-au.blogspot.se/2012/06/build-bringing-lego-bricks-to-chrome.html</a></a></p>

<p><img class="size-full wp-image-63" title="Build with Chrome" alt="" src="/img/blog/posts/2012/06/agigen-blog-lego-irl.png" />
Research for the project (or just an excuse to build cool LEGO stuff)</p>

    </article>
</div>

<footer class="blog-post__footer">
    <div class="container container--tight">
        <div class="grid">
            <div class="grid__item one-half">
                
                    <a class="blog-post__nav blog-post__nav--prev" href="/blog/2012-09-06-fwa-build-with-chrome/">
                        <div class="epsilon">Newer post</div>
                        <div class="blog-post__nav__imgwrapper">
                            
                                <img src="/img/blog/build_fwa_320.jpg" class="post__image">
                            
                        </div>
                        <h5 class="blog-post__nav__meta">
                            
                                <span class="blog-post__nav__category--backstage">Backstage</span>
                            
                            Wed, Jun 6, 2012
                        </h5>
                        <h4 class="blog-post__nav__title">FWA - Build with Chrome</h4>
                    </a>
                
            </div><div class="grid__item one-half">
                
                    <a class="blog-post__nav blog-post__nav--next" href="/blog/2012-06-06-fwa-only-the-liberation/">
                        <div class="epsilon">Older post</div>
                        <div class="blog-post__nav__imgwrapper">
                            
                                <img src="/img/blog/only_fwa_320.jpg" class="post__image">
                            
                        </div>
                        <h5 class="blog-post__nav__meta">
                            
                                <span class="blog-post__nav__category--backstage">Backstage</span>
                            
                            Wed, Jun 6, 2012
                        </h5>
                        <h4 class="blog-post__nav__title">FWA ONLY - The Liberation</h4>
                    </a>
                
            </div>
        </div>
    </div>
</footer>

</div>
<footer class="main-footer">
    <div class="container">
        <h1 class="main-footer__title hidden">
            <a href="/" title="Agigen">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 244.8 190.6" enable-background="new 0 0 244.8 190.6" xml:space="preserve">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M92.1,3.8C105.7,15.2,219.5,105.1,240,185.9c-69.6-117.8-200.3,13.7-233.3,0
                        C-9.8,181.3,80.7-1.3,92.1,3.8z"></path>
                </svg>
            </a>
        </h1>

        <nav class="main-footer__links main-footer__links--left">
            <a href="https://www.facebook.com/agigen" target="_blank" class="main-footer__link main-footer__link--facebook">
                <span class="hidden">Facebook</span>
                <img src="/img/icons/icon_fb.svg" alt="" width="44" height="22">
            </a>
            <a href="https://github.com/agigen" target="_blank" class="main-footer__link main-footer__link--github">
                <span class="hidden">Github</span>
                <img src="/img/icons/icon_github.svg" alt="" width="44" height="22">
            </a>
            <a href="https://dribbble.com/agigen" target="_blank" class="main-footer__link main-footer__link--dribble">
                <span class="hidden">Dribbble</span>
                <img src="/img/icons/icon_dribbble.svg" alt="" width="44" height="22">
            </a>
        </nav>

        <nav class="main-footer__links main-footer__links--right">
            <a href="/contact" class="main-footer__link main-footer__link--bordered">Contact &amp; Map</a>
        </nav>
    </div>
</footer>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/js/jquery-2.1.1.min.js"><\/script>')</script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.0-rc.2/angular.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.0-rc.2/angular-touch.js"></script>
    <script src="//agigen-slack-chat.appspot.com/_ah/channel/jsapi"></script>
    <script src="//agigen-slack-chat.appspot.com/static/chat.js"></script>
    <script src="//www.youtube.com/iframe_api"></script>
    <script src="/js/agigen.jquery-in-view.js"></script>
    <script src="/js/agigen.js?v=1"></script>
    </body>
</html>

